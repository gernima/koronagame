import telebot
import time
from telebot import types
from threading import Thread
import pymorphy2
import sqlite3
from random import choice, random
from event import events

bot = telebot.TeleBot('1077053623:AAE8yg9jrRas7h7mTgKaNQAjOTeIsgwJHGI')
print('start')


return_family_menu = telebot.types.InlineKeyboardMarkup(row_width=1)
return_family_menu.add(
    telebot.types.InlineKeyboardButton(text='–ù–∞–∑–∞–¥', callback_data='bunker_family_return'),
    telebot.types.InlineKeyboardButton(text='–ü–æ–∫–æ—Ä–º–∏—Ç—å', callback_data='bunker_family_feed')
    )
a = {0: {'inventory': [], 'name': 'a', 'mother': 1, 'dad': 1, 'brother': 1, 'sister': 1, 'day': 1,
         'dad_bd': {'mood': 50, 'hungry': 50, 'water': 50, 'immunity': 50, 'emoji': 'üòï'},
         'mother_bd': {'mood': 50, 'hungry': 50, 'water': 50, 'immunity': 50, 'emoji': 'üòå'},
         'brother_bd': {'mood': 50, 'hungry': 50, 'water': 50, 'immunity': 50, 'emoji': 'ü§®'},
         'sister_bd': {'mood': 50, 'hungry': 50, 'water': 50, 'immunity': 50, 'emoji': 'üòî'}}}

con = sqlite3.connect("bd.db", check_same_thread=False)
cur = con.cursor()
time_list = {}
family = {}
user_list = []
weight_list = {}
morph = pymorphy2.MorphAnalyzer().parse
FOOD = {'father': ('–ü–∞–ø–∞', 'father', 15, 1),
        'daughter': ('–î–æ—á—å', 'daughter',15, 1),
        'mother': ('–ú–∞–º–∞', 'mother', 15, 1),
        'son': ('–°—ã–Ω', 'son', 15, 1),
        'mask': ('–º–∞—Å–∫–∞', 'mask', 3, 1),
        'medicinechest': ('–∞–ø—Ç–µ—á–∫–∞', 'medicinechest', 3, 1),
        'soap': ('–º—ã–ª–æ', 'soap', 3, 1),
        'obrez': ('–æ–±—Ä–µ–∑', 'obrez', 50, 1, 1),
        'cannedfood': ('–∫–æ–Ω—Å–µ—Ä–≤—ã', 'cannedfood', 3, 6, 50),
        'water': ('–≤–æ–¥–∞', 'water', 2, 6, 50)}
package = {}


def bd_family(chat_id, data):
    x = 0
    for i in a[chat_id]['dad_bd'].keys():
        a[chat_id][i] = data[x]
        x += 1


def event_run(event, message):
    if event == '–ø–∞—É–∫–∏ –≤ –±—É–Ω–∫–µ—Ä–µ':
        bot.send_message(message.chat.id, '–≠—Ç–æ –±–µ–∑—É–º–∏–µ! –ú—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏–º –ø–∞—É–∫–æ–≤. –û–Ω–∏ –≤ –Ω–∞—à–µ–º '
                                          '—Å—É–ø–µ. –û–Ω–∏ –≤ –Ω–∞—à–µ–π –≤–æ–¥–µ. –ú—ã –∫–ª—è–Ω–µ–º—Å—è, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è, –∏ –æ–Ω–∏'
                                          ' —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–æ–ª—å—à–µ —Å –∫–∞–∂–¥—ã–º —Ä–∞–∑–æ–º, –∫–æ–≥–¥–∞ –º—ã –∏—Ö –≤–∏–¥–∏–º! –¢–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –Ω–µ –º–æ–∂–µ—Ç. –ü—Ä–∏—à–ª–æ '
                                          '–≤—Ä–µ–º—è –≤–µ—Å—Ç–∏ –≤–æ–π–Ω—É —Å —ç—Ç–∏–º–∏ –ø–∞—É–∫–∞–º–∏!')
        markup.add(
            types.InlineKeyboardButton(text='–í–∑—è—Ç—å', callback_data='event_canned_food_get'),
            types.InlineKeyboardButton(text='–í—ã–±—Ä–æ—Å–∏—Ç—å', callback_data='event_canned_food_delete'),
            types.InlineKeyboardButton(text='–ù–∞–¥–µ—Ç—å –≤—Å–µ–º', callback_data='event_canned_food_put_on'))
    elif event == '–º–∞–º–∞ –Ω–∞—á–∞–ª–∞ —á–∏—Ö–∞—Ç—å':
        bot.send_message(message.chat.id, '–º–∞–º–∞ –∫–∞—à–ª—è–µ—Ç')  # –º–∞–º–∞ —Ç–µ—Ä—è–µ—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç
    elif event == '–Ω–∞—à–ª–∏ –∫–æ–Ω—Å–µ—Ä–≤—ã':
        markup = types.InlineKeyboardMarkup()
        markup.add(
            types.InlineKeyboardButton(text='–í–∑—è—Ç—å', callback_data='event_canned_food_get'),
            types.InlineKeyboardButton(text='–í—ã–±—Ä–æ—Å–∏—Ç—å', callback_data='event_canned_food_delete'),
            types.InlineKeyboardButton(text='–ù–∞–¥–µ—Ç—å –≤—Å–µ–º', callback_data='event_canned_food_put_on')
        )
        bot.send_message(message.chat.id, '–í—ã –Ω–∞—à–ª–∏ –∫–æ–Ω—Å–µ—Ä–≤—ã', reply_markup=markup)


def bunker(message):
    get_data_from_bd(message.chat.id)
    bot.send_message(message.chat.id, f'–õ–æ–∫–∞—Ü–∏—è: –ë—É–Ω–∫–µ—Ä\n–î–µ–Ω—å {a[message.chat.id]["day"]}',
                     reply_markup=get_bunker_keyboard(message.chat.id))


def get_data_from_bd(chat_id):
    try:
        if chat_id not in a.keys():
            a[chat_id] = a[0]
        q = """Select {} from {} where chat_id == {}"""
        bd_family(chat_id, list(cur.execute(q.format('*', 'dad', chat_id)).fetchone()[1:]))
        bd_family(chat_id, list(cur.execute(q.format('*', 'mother', chat_id)).fetchone()[1:]))
        bd_family(chat_id, list(cur.execute(q.format('*', 'brother', chat_id)).fetchone()[1:]))
        bd_family(chat_id, list(cur.execute(q.format('*', 'sister', chat_id)).fetchone()[1:]))

        a[chat_id]['inventory'] = str(
            cur.execute(q.format('inventory', 'saves', chat_id)).fetchone()[0]).split(';')
        a[chat_id]['name'] = cur.execute(q.format('name', 'saves', chat_id)).fetchone()[0]
        a[chat_id]['mother'] = cur.execute(q.format('mother', 'saves', chat_id)).fetchone()[0]
        a[chat_id]['dad'] = cur.execute(q.format('dad', 'saves', chat_id)).fetchone()[0]
        a[chat_id]['brother'] = cur.execute(q.format('brother', 'saves', chat_id)).fetchone()[0]
        a[chat_id]['sister'] = cur.execute(q.format('sister', 'saves', chat_id)).fetchone()[0]
        a[chat_id]['day'] = cur.execute(q.format('day', 'saves', chat_id)).fetchone()[0]
    except:
        pass


def get_bunker_keyboard(chat_id):
    get_data_from_bd(chat_id)
    bunker = telebot.types.InlineKeyboardMarkup(row_width=5)
    butts = []
    if a[chat_id]['dad']:
        butts.append(telebot.types.InlineKeyboardButton(text=f'–ü–∞–ø–∞ {a[chat_id]["dad_bd"]["emoji"]}',
                                                        callback_data='bunker_family_dad'))
    if a[chat_id]['mother']:
        butts.append(
            telebot.types.InlineKeyboardButton(text=f'–ú–∞–º–∞ {a[chat_id]["mother_bd"]["emoji"]}',
                                               callback_data='bunker_family_mother'))
    if a[chat_id]['brother']:
        butts.append(
            telebot.types.InlineKeyboardButton(text=f'–ë—Ä–∞—Ç {a[chat_id]["brother_bd"]["emoji"]}',
                                               callback_data='bunker_family_brother'))
    if a[chat_id]['brother']:
        butts.append(
            telebot.types.InlineKeyboardButton(text=f'–°–µ—Å—Ç—Ä–∞ {a[chat_id]["sister_bd"]["emoji"]}',
                                               callback_data='bunker_family_sister'))
    bunker.add(*butts)
    bunker.add(telebot.types.InlineKeyboardButton(text='–ñ—É—Ä–Ω–∞–ª', callback_data='bunker_journal'),
               telebot.types.InlineKeyboardButton(text='–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', callback_data='bunker_inventory'))
    bunker.add(
        telebot.types.InlineKeyboardButton(text='–í—ã—Ö–æ–¥ –≤ –ø—É—Å—Ç–æ—à—å', callback_data='bunker_wasteland'),
        telebot.types.InlineKeyboardButton(text='–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å', callback_data='bunker_next_day'))

    return bunker


def create_family_bd(chat_id):
    if cur.execute("""Select chat_id from dad where chat_id == {}""".format(chat_id)).fetchone():
        cur.execute(
            """UPDATE dad SET chat_id = ?, mood = ?, hungry = ?, water = ? immunity = ? emoji = ? WHERE chat_id == ?""",
            (chat_id, a[chat_id]['dad_bd']['mood'], a[chat_id]['dad_bd']['hungry'],
             a[chat_id]['dad_bd']['water'],
             a[chat_id]['dad_bd']['immunity'], a[chat_id]['dad_bd']['emoji'],
             chat_id))
        cur.execute(
            """UPDATE mother SET chat_id = ?, mood = ?, hungry = ?, water = ? immunity = ? emoji = ? WHERE chat_id == ?""",
            (chat_id, a[chat_id]['mother_bd']['mood'], a[chat_id]['mother_bd']['hungry'],
             a[chat_id]['mother_bd']['immunity'], a[chat_id]['mother_bd']['emoji'],
             a[chat_id]['mother_bd']['water']))
        cur.execute(
            """UPDATE brother SET chat_id = ?, mood = ?, hungry = ?, water = ? immunity = ? emoji = ? WHERE chat_id == ?""",
            (chat_id, a[chat_id]['brother_bd']['mood'], a[chat_id]['brother_bd']['hungry'],
             a[chat_id]['brother_bd']['immunity'], a[chat_id]['brother_bd']['emoji'],
             a[chat_id]['brother_bd']['water']))
        cur.execute(
            """UPDATE sister SET chat_id = ?, mood = ?, hungry = ?, water = ? immunity = ? emoji = ? WHERE chat_id == ?""",
            (chat_id, a[chat_id]['sister_bd']['mood'], a[chat_id]['sister_bd']['hungry'],
             a[chat_id]['sister_bd']['immunity'], a[chat_id]['sister_bd']['emoji'],
             a[chat_id]['sister_bd']['water']))
    else:
        cur.execute("""INSERT INTO dad VALUES (?, ?, ?, ?, ?, ?)""",
                    (chat_id, a[chat_id]['dad_bd']['mood'], a[chat_id]['dad_bd']['hungry'],
                     a[chat_id]['dad_bd']['water'], a[chat_id]['dad_bd']['immunity'],
                     a[chat_id]['dad_bd']['emoji']))
        cur.execute("""INSERT INTO mother VALUES (?, ?, ?, ?, ?, ?)""",
                    (chat_id, a[chat_id]['mother_bd']['mood'], a[chat_id]['mother_bd']['hungry'],
                     a[chat_id]['mother_bd']['water'], a[chat_id]['mother_bd']['immunity'],
                     a[chat_id]['mother_bd']['emoji']))
        cur.execute("""INSERT INTO brother VALUES (?, ?, ?, ?, ?, ?)""",
                    (chat_id, a[chat_id]['brother_bd']['mood'], a[chat_id]['brother_bd']['hungry'],
                     a[chat_id]['brother_bd']['water'], a[chat_id]['brother_bd']['immunity'],
                     a[chat_id]['brother_bd']['emoji']))
        cur.execute("""INSERT INTO sister VALUES (?, ?, ?, ?, ?, ?)""",
                    (chat_id, a[chat_id]['sister_bd']['mood'], a[chat_id]['sister_bd']['hungry'],
                     a[chat_id]['sister_bd']['water'], a[chat_id]['sister_bd']['immunity'],
                     a[chat_id]['sister_bd']['emoji']))
    con.commit()


def edit_message_for_family(call):
    who_bd = call.data[len('bunker_family_'):] + '_bd'
    who = ''
    if call.data[len('bunker_family_'):] == 'dad':
        who = '–ü–∞–ø–∞'
    elif call.data[len('bunker_family_'):] == 'mother':
        who = '–ú–∞–º–∞'
    elif call.data[len('bunker_family_'):] == 'sister':
        who = '–°–µ—Å—Ç—Ä–∞'
    elif call.data[len('bunker_family_'):] == 'brother':
        who = '–ë—Ä–∞—Ç'
    bot.edit_message_text(chat_id=call.from_user.id, message_id=call.message.message_id,
                          text=f'{who} {a[call.from_user.id][who_bd]["emoji"]}'
                               f'\n–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {a[call.from_user.id][who_bd]["mood"]}'
                               f'\n–°—ã—Ç–æ—Å—Ç—å: {a[call.from_user.id][who_bd]["hungry"]}'
                               f'\n–ñ–∞–∂–¥–∞: {a[call.from_user.id][who_bd]["water"]}'
                               f'\n–ò–º–º—É–Ω–∏—Ç–µ—Ç: {a[call.from_user.id][who_bd]["immunity"]}',
                          reply_markup=return_family_menu)


def save_update_to_bd(chat_id):
    x = cur.execute("""Select chat_id from saves where chat_id == ?""", (chat_id,)).fetchone()
    if x:
        inventory = ';'.join(a[chat_id]['inventory'])
        cur.execute(
            """UPDATE saves SET chat_id = ?, inventory = ?, name = ?, mother = ?, dad = ?, brother = ?, sister = ?, day = ? WHERE chat_id == ?""",
            (chat_id, inventory, a[chat_id]['name'], a[chat_id]['mother'], a[chat_id]['dad'],
             a[chat_id]['brother'], a[chat_id]['sister'], a[chat_id]['day'], chat_id))
        create_family_bd(chat_id)
    else:
        inventory = ';'.join(a[chat_id]['inventory'])
        cur.execute("""INSERT INTO saves VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                    (chat_id, inventory, a[chat_id]['name'], a[chat_id]['mother'], a[chat_id]['dad'],
                     a[chat_id]['brother'], a[chat_id]['sister'], a[chat_id]['day']))
        create_family_bd(chat_id)
    con.commit()


def items_how_many_things_are_left(user, item):
    return FOOD[item][3] - package.get(user, {}).get(FOOD[item][1], 0)


def items(user):
    markup = types.InlineKeyboardMarkup()
    item_1 = types.InlineKeyboardButton(text='', callback_data='item_')
    markup.add(types.InlineKeyboardButton(text='–ë–µ–∂–∏–∏–∏–º!!!!!', callback_data='run'))
    family_button = {'father': types.InlineKeyboardButton(
        text=f'{items_how_many_things_are_left(user, "father")} x –ü–∞–ø–∞ - 15',
        callback_data='item_father'),
        'mother': types.InlineKeyboardButton(
            text=f'{items_how_many_things_are_left(user, "mother")} x –ú–∞–º–∞ - 15',
            callback_data='item_mother'),
        'son': types.InlineKeyboardButton(
            text=f'{items_how_many_things_are_left(user, "son")} x –°—ã–Ω - 15',
            callback_data='item_son'),
        'daughter': types.InlineKeyboardButton
        (text=f'{items_how_many_things_are_left(user, "daughter")} x –î–æ—á—å - 15',
         callback_data='item_daughter'), }
    item_button = [types.InlineKeyboardButton(
            text=f'{items_how_many_things_are_left(user, key)} x {value[0]} - {value[2]}',
            callback_data=f'item_{key}')
        for key, value in FOOD.items() if package.get(user, {}).get(value[1], 0) != value[3]
                                          and value[1] not in family_button.keys()]
    button = [family_button[i] for i in
              filter(lambda x: FOOD[x][0] not in family.get(user, []), family_button)] + \
             item_button
    for i in range(0, len(button), 2):
        markup.add(*button[i:i + 2])
    return markup


def car(message):
    text = ['_', '_', '_', '_', '_', '_', '_', '_', '_', '_', '_', '_', '_', '_',
            'üöóüí®']
    run = bot.send_message(message.chat.id, '_______________üöóüí®')
    for i in range(1, len(text)):
        time.sleep(0.1)
        bot.edit_message_text(chat_id=run.chat.id, message_id=run.message_id,
                              text=''.join(text))
        text[- i - 1], text[- i] = text[- i], text[- i - 1]
    bot.edit_message_text(chat_id=run.chat.id, message_id=run.message_id,
                          text='üöó________________')


def time_cheker(call, user):
    second = 60
    sms = bot.send_message(call.message.chat.id, '–£ —Ç–µ–±—è –æ—Å—Ç–∞–ª–æ—Å—å {} {} –∏ {} –º–µ—Å—Ç–∞ –≤ –±—É–Ω–∫–µ—Ä–µ'.format(
        second, morph('—Å–µ–∫—É–Ω–¥–∞')[0].make_agree_with_number(second).word, weight_list[user]),
                           reply_markup=items(user))
    while second > 0:
        time.sleep(1)
        second -= 1
        bot.edit_message_text(chat_id=sms.chat.id, message_id=sms.message_id,
                              text='–£ —Ç–µ–±—è –æ—Å—Ç–∞–ª–æ—Å—å {} {}  –∏ {} –º–µ—Å—Ç–∞ –≤ –±—É–Ω–∫–µ—Ä–µ'.format(
                                  second, morph('—Å–µ–∫—É–Ω–¥–∞')[0].make_agree_with_number(second).word,
                                  weight_list[user]), reply_markup=items(user))
        if weight_list[user] < 1 or second == 0:
            if package.get(user, False):
                bot.send_message(call.message.chat.id, '–í–æ—Ç —á—Ç–æ –≤—ã –≤–∑—è–ª–∏ —Å —Å–æ–±–æ–π:\n' +
                                 '\n'.join(
                                     '{}. {} x {}'.format(i + 1, FOOD[item[0]][0], item[1]) for i, item in
                                     enumerate(package[user].items())))
            else:
                bot.send_message(call.message.chat.id,
                                 '–í—ã –Ω–∏—á–µ–≥–æ —Å —Å–æ–±–æ–π –Ω–µ –≤–∑—è–ª–∏, –¥–∞ —Ç—ã —Ö–∞—Ä–¥–∫–æ—Ä–Ω—ã–π —á–µ–ª')
            bot.send_message(call.message.chat.id, '–ò–∑ —Å–µ–º—å–∏ –≤—ã –≤–∑—è–ª–∏:\n' + '\n'.join(
                '{}. {}'.format(i + 1, item) for i, item in
                enumerate(family.get(user, ['–ù–∏–∫–æ–≥–æ, –Ω–æ –∫–∞–∫ –∂–µ —Ç–∞–∫?)']))))
            bot.edit_message_text(chat_id=sms.chat.id, message_id=sms.message_id,
                                  text='–í—Ä–µ–º—è –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å' if second == 0 else '–ú–µ—Å—Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å')
            markup = types.ReplyKeyboardMarkup(True)
            markup.add(
                types.InlineKeyboardButton('–î–æ–Ω–∞—Ç'),
                types.InlineKeyboardButton('–ü–æ–¥–¥–µ—Ä–∂–∫–∞'),
                types.InlineKeyboardButton('–ü–æ–º–æ—â—å –Ω–æ–≤–∏—á–∫–∞–º')
            )
            bot.send_message(call.message.chat.id, '–ü–æ—Ä–∞ –≤ –±—É–Ω–∫–µ—Ä', reply_markup=markup)
            car(call.message)
            bunker(call.message)
            # a[call.from_user.id] = a[0]
            # a[call.from_user.id]['inventory'] = package[user]
            # save_update_to_bd(call.from_user.id)
            print(package)
            for i in (package, weight_list, family):
                if user in i:
                    del i[user]
            return

@bot.message_handler(commands=['start', 'new_game'])
def start_message(message):
    if message.text == '/start':
        if message.from_user.username not in user_list:
            laste_name = message.from_user.last_name
            if not laste_name:
                laste_name = ''
            name = message.from_user.first_name + ' ' + laste_name
            murkup = types.InlineKeyboardMarkup(row_width=2)
            item_1 = types.InlineKeyboardButton('–î–∞', callback_data='play_yes')
            item_2 = types.InlineKeyboardButton('–ù–µ—Ç', callback_data='play_no')
            murkup.add(item_1, item_2)
            if message.chat.id not in a.keys():
                a[message.chat.id] = a[0]
            a[message.chat.id]['name'] = name.strip()
            bot.send_message(message.chat.id, '{}, —Ç—ã –≤—ã–∂–∏–ª?\n–†–µ—à–∏—à—å—Å—è —Å—ã–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—É?'.format(name),
                             reply_markup=murkup)
            user_list.append(message.from_user.username)
            print("–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", user_list)
        else:
            bot.delete_message(message.chat.id, message.message_id)
    elif message.text == '/new_game':
        murkup = types.InlineKeyboardMarkup(row_width=2)
        item_1 = types.InlineKeyboardButton('–î–∞', callback_data='play_start')
        item_2 = types.InlineKeyboardButton('–ù–µ—Ç', callback_data='play_continue')
        murkup.add(item_1, item_2)
        bot.send_message(message.chat.id, '–¢—ã —Ç–æ—á–Ω–æ —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å –≤—Å–µ —Å –Ω–∞—á–∞–ª–∞?',
                         reply_markup=murkup)


@bot.message_handler(content_types=['text'])
def send_text(message):
    if message.text.lower() == '1':
        bunker(message)


@bot.callback_query_handler(func=lambda call: 'bunker' in call.data)
def bunker_logic(call):
    get_data_from_bd(call.from_user.id)
    if call.data == 'bunker_family_dad':
        edit_message_for_family(call)
    elif call.data == 'bunker_family_mother':
        edit_message_for_family(call)
    elif call.data == 'bunker_family_sister':
        edit_message_for_family(call)
    elif call.data == 'bunker_family_brother':
        edit_message_for_family(call)
    elif call.data == 'bunker_family_return':
        bot.edit_message_text(chat_id=call.from_user.id, message_id=call.message.message_id,
                              text=f'–õ–æ–∫–∞—Ü–∏—è: –ë—É–Ω–∫–µ—Ä\n–î–µ–Ω—å {a[call.from_user.id]["day"]}',
                              reply_markup=get_bunker_keyboard(call.from_user.id))
    elif call.data == 'bunker_next_day':
        try:
            a[call.from_user.id]['day'] += 1
            save_update_to_bd(call.from_user.id)
            bot.edit_message_text(chat_id=call.from_user.id, message_id=call.message.message_id,
                                  text=f'–õ–æ–∫–∞—Ü–∏—è: –ë—É–Ω–∫–µ—Ä\n–î–µ–Ω—å {a[call.from_user.id]["day"]}',
                                  reply_markup=get_bunker_keyboard(call.from_user.id))
        except Exception as e:
            pass
    elif call.data == 'bunker_family_feed':
        name = call.message.text.split("\n")[0]
        markup = types.InlineKeyboardMarkup(row_width=1)
        markup.add(types.InlineKeyboardButton(text='–ù–∞–∑–∞–¥', callback_data='bunker_family_return'),
                   types.InlineKeyboardButton(text=f'{1} x –ö–æ–Ω—Å–µ—Ä–≤—ã + 50 —Å—ã—Ç–æ—Å—Ç–∏', callback_data=f'bunker_food_cannedfood_{name}'),
                   types.InlineKeyboardButton(text=f'{1} x –í–æ–¥–∞ + 50 –≤–æ–¥–∞', callback_data=f'bunker_food_water_{name}'))
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=markup)
    elif 'food' in call.data:
        name_ = call.data.split('_')[-1]
        markup = types.InlineKeyboardMarkup(row_width=1)
        markup.add(types.InlineKeyboardButton(text='–ù–∞–∑–∞–¥', callback_data='bunker_family_return'),
                   types.InlineKeyboardButton(text=f'{1} x –ö–æ–Ω—Å–µ—Ä–≤—ã + 50 —Å—ã—Ç–æ—Å—Ç–∏',
                                              callback_data=f'bunker_food_cannedfood_{name_}'),
                   types.InlineKeyboardButton(text=f'{1} x –í–æ–¥–∞ + 50 –≤–æ–¥–∞',
                                              callback_data=f'bunker_food_water_{name_}'))
        if '–ü–∞–ø–∞' in name_:
            name = 'dad_bd'
        elif '–ú–∞–º–∞' in name_:
            name = 'mother_bd'
        elif '–ë—Ä–∞—Ç' in name_:
            name = 'brother_bd'
        elif '–°–µ—Å—Ç—Ä–∞' in name_:
            name = 'sister_bd'
        if 'cannedfood' in call.data:
            if a[call.message.chat.id][name]['hungry'] <= 90:
                a[call.message.chat.id][name]['hungry'] += 10
            else:
                return
        else:
            if a[call.message.chat.id][name]['water'] <= 90:
                a[call.message.chat.id][name]['water'] += 10
            else:
                return
        bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=f'{name_}'
                                f'\n–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {a[call.from_user.id][name]["mood"]}'
                               f'\n–°—ã—Ç–æ—Å—Ç—å: {a[call.from_user.id][name]["hungry"]}'
                               f'\n–ñ–∞–∂–¥–∞: {a[call.from_user.id][name]["water"]}'
                               f'\n–ò–º–º—É–Ω–∏—Ç–µ—Ç: {a[call.from_user.id][name]["immunity"]}', reply_markup=markup)
    elif call.data == 'bunker_journal':
        chance = random()
        if chance < .4:
            event = choice(events['good'])
        elif .5 > chance > .4:
            event = choice(events['bad'])
        else:
            event = choice(events['choice'])
        event_run(event, call.message)


@bot.callback_query_handler(func=lambda call: 'event' in call.data)
def event_logic(call):
    event_type = call.data[6:]
    bot.delete_message(chat_id=call.message.chat.id, message_id=call.message.message_id)
    if event_type == 'canned_food_get':
        bot.send_message(call.message.chat.id, '–≤—ã –≤–∑—è–ª–∏ –º–∞—Å–∫–∏')
    if event_type == 'canned_food_delete':
        bot.send_message(call.message.chat.id, '–≤—ã –≤—ã–±—Ä–æ—Å–∏–ª–∏ –º–∞—Å–∫–∏')
    if event_type == 'canned_food_put_on':
        bot.send_message(call.message.chat.id,
                         '–≤—ã –æ–¥–µ–ª–∏ –º–∞—Å–∫–∏, –æ–Ω–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å —á–µ–º —Ç–æ –∑–∞—Ä–∞–∑–Ω—ã —É –≤—Å–µ–π —Å–µ–º—å–∏ –ø–∞–¥–∞–µ—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç')


@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    global weight_list
    user = call.from_user.username
    name = call.data
    name_type = name.split('_')[0]
    if name_type == 'play':
        type = name.split('_')[1]
        bot.delete_message(chat_id=call.message.chat.id, message_id=call.message.message_id)
        if type == 'yes':
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton(text='–°–ø—Ä—è—Ç–∞—Ç—å—Å—è', callback_data='play_start'),
                       types.InlineKeyboardButton(text='–°–¥–∞—Ç—å—Å—è', callback_data='play_end'))
            bot.send_message(call.message.chat.id,
                             '–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è –≤—ã–∂–∏–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–º –º–∏—Ä–µ, –∫–æ—Ç–æ—Ä–æ–º—É –≥—Ä–æ–∑–∏—Ç –ø–∞–Ω–¥–µ–º–∏—è, –≤—ã —Ä–µ—à–∞–µ—Ç–µ—Å—å —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è –≤ –±—É–Ω–∫–µ—Ä–µ, —É —Ç–µ–±—è –µ—Å—Ç—å 60 —Å–µ–∫—É–Ω–¥ —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –≤–µ—â–∏ –¥–æ —Ç–æ–≥–æ –∫–∞–∫ –ø—Ä–∏–µ–¥–µ—Ç –ø–æ–ª–∏—Ü–∏—è –∏–∑-–∑–∞ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–π –Ω–∞ –∑–∞—Ä–∞–∂–µ–Ω–∏–µ',
                             reply_markup=markup)
        elif type == 'no':
            murkup = types.InlineKeyboardMarkup(row_width=2)
            item_1 = types.InlineKeyboardButton('–î–∞', callback_data='play_yes')
            item_2 = types.InlineKeyboardButton('–ù–µ—Ç', callback_data='play_no')
            murkup.add(item_1, item_2)
            bot.send_message(call.message.chat.id, '–°—ã–∫–∞–Ω—É–ª, –º–æ–∂–µ—Ç –≤—Å–µ —Ç–∞–∫–∏ —Å—ã–≥—Ä–∞–µ—à—å?',
                             reply_markup=murkup)
        elif type == 'start':
            print('–°—á–µ—Ç—á–∏–∫: ' + call.from_user.username)
            weight_list[user] = 50
            thread1 = Thread(target=time_cheker, args=(call, user))
            thread1.start()
            time_list[user] = thread1
        elif type == 'end':
            bot.send_message(call.message.chat.id,
                             '–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ, –Ω–æ –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ –≤—ã —É–∂–µ —Ä–µ–∞–ª—å–Ω–æ –∑–∞—Ä–∞–∑–∏–ª–∏—Å—å –≤ –æ–±—â–µ–π –±–æ–ª—å–Ω–∏—Ü–µ, –∞ –≤–µ–¥—å –º–æ–≥–ª–∏ —Ä–∏—Å–∫–Ω—É—Ç—å –∏ –≤—ã–∂–∏—Ç—å')
        elif type == 'continue':
            pass
    elif name_type == 'item':
        item = FOOD[name.split('_')[1]]
        item_weight = item[2]
        item_name = item[0]
        if weight_list[user] != 0:
            if weight_list[user] - item_weight < 0:
                bot.answer_callback_query(callback_query_id=call.id, text='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞')
            else:
                text = '–ú—ã –ø–æ–ª–æ–∂–∏–ª–∏ –≤ —Å—É–º–∫—É: {}'
                if item[1] in ['mother', 'daughter', 'son', 'father']:
                    if item_name not in family.get(user, []):
                        text = '–í—ã –≤–∑—è–ª–∏ —Å —Å–æ–±–æ–π –≤ –±—É–Ω–∫–µ—Ä: {}'
                        family[user] = family.get(user, []) + [item_name]
                        bot.answer_callback_query(callback_query_id=call.id, text=text.format(
                            morph(item_name)[0].inflect({'accs'}).word))
                        weight_list[user] -= item_weight
                    else:
                        bot.answer_callback_query(callback_query_id=call.id,
                                                  text='–í—ã —É–∂–µ –≤–∑—è–ª–∏ —ç—Ç–æ–≥–æ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏')
                else:
                    package[user] = package.get(call.from_user.username, {})
                    if package[user].get(item[1], 0) != item[3]:
                        package[user][item[1]] = package[user].get(item[1], 0) + 1
                        weight_list[user] -= item_weight
                        bot.answer_callback_query(callback_query_id=call.id,
                                                  text=text.format(
                                                      morph(item_name)[0].inflect({'accs'}).word))
    elif name_type == 'run':
        print(user, '—É–±–µ–∂–∞–ª')
        weight_list[user] = 0


try:
    bot.polling()
except Exception as e:
    print('–±–æ—Ç —É–ø–∞–ª, –º–æ–ª–æ–¥—Ü–∞\n', e)
